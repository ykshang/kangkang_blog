# 4、如何优化生产环境的运行性能？

::: tip 总结

- 调整代码拆分和 sourceMap 的颗粒度，控制生成文件数量和体积，提高加载速度；
- 代码中按需引入、魔法注释标记无副作用的模块来配合 Tree sharking，优化输出。
- 调整文件指纹的 hash 复杂度，提高缓存命中率，同事防止哈希碰撞；、
- 提取公共模块，第三方依赖、runtime 文件；
- js、css 的兼容性处理
- 压缩代码、图片、视频 ，必要时利用 CDN；
- 预加载、懒加载、预读取技术

:::

要优化 Webpack 构建的应用程序性能，可以采取以下措施：

## 一、webpack 的配置优化

### 1、设置生产模式会自动启用一些优化策略

在生产模式下，`webpack`会自动启用一些优化选项，包括：**缓存**、**Tree Shaking**、**html 代码压缩**、**js 代码压缩**

### 2、设置合适代码拆分策略（webpack 的懒加载）

- 设置拆分的精细度： 如调整并行加载数量，最大体积，最小体积等
- 路由、复杂组件的懒加载：路由的按需加载（使用 es 模块化的异步加载`import()`）配合 **webpack 魔法名称**，提示 webpack 拆分
- 公共代码提取：通过降低重复率，来降低文件体积，如果不提取出来，webpack 会在每一个文件中添加一份公共代码。
- runtime 文件提取：和公共代码类似，runtime 代码是 webpack 用来处理模块依赖的辅助代码。
- vendor 第三方依赖提取：主要指的 node_module，可以通过缓存组来拆分打包

### 3、使用预加载技术优化懒加载

在路由和组件的懒加载中添加魔法名称，使用 Webpack 的`preload`和`prefetch`功能来预加载和推迟加载资源。

### 4、更复杂的哈希值计算，提高缓存命中率

代码打包的时候，在 **避免哈希碰撞** 的情况下，对生成的打包文件采用**更复杂的哈希值计算**，可以有效降低打包的影响范围，从而利用浏览器的缓存，**提高缓存命中率**

### 5、代码压缩、转化

- **Html、Js：** `webpack5`会对`html`和`js`默认压缩
- **CSS：** `css` 需要单独处理，可以使用`MiniCssExtractPlugin `插件。
- **视频：** 视频压缩；上传 CDN、静态资源服务器
- **图片：** 图片压缩；转化为 dataUrl 格式；多张小图片合并成大图；使用字体图标库代替；上传 CDN、静态资源服务器。

### 6、Js 和 CSS 的兼容性处理

- **Js：** 可以使用`postCss`去处理`CSS`的兼容性，
- **CSS：** 使用`babel`和`core-js`去处理 js 的兼容性

### 7、关闭或降低 sourceMap 的生成精度

非必要情况下，可以 **关闭**，甚至 **降低** sourceMap 生成 map 文件的**精细度** ，可以非常有效的降低代码生成体积，提高加载速度。

### 8、使用 PWA 技术，处理某些极端情况

渐进式网络应用程序(progressive web application - PWA)：是一种可以提供类似于 native app(原生应用程序) 体验的 Web App 的技术。

其中最重要的是，在用户 **突然离线** 时，应用程序能够 **继续运行** 功能。通过 Service Workers 技术实现的。

## 二、代码中的优化

### 1、适配 Tree Shaking

- 引入公共组件时，按需引入需要的部分，这样 webpack 会在打包带时候将未引入的部分剔除

  ```js
  import { funA } from "./Module";
  ```

- 封装组件的时候，尽量降低文件的副作用，配合`/*#__PURE__*/`标记函数，配合 Tree Shaking 无副作用移除代码

  ```js
  const result = /*#__PURE__*/ someFunction();
  ```

### 2、路由或组件的按需加载，即懒加载

路由或组件的懒加载可以配合缓存和代码拆分

### 3、图片、视频的压缩、转化

- **合并图片：** 跟样式有关的小尺寸图片，比如用按钮的边框，可以考虑 **合并成一张图片** ，在 css 中用偏移量去控制。从而通过**减少文件数量来减少 http 请求**

- **静态资源服务器、CDN：** 可以考虑使用静态资源服务器或 CDN 服务器，将大体积的图片和视频上传，在代码中使用 **URL 地址** 去引入资源。

### 4、CDN 加速

以下资源可以使用 CDN 加速，来提高加载速度，但是要**控制数量**，**避免大幅度增加 Http 请求数量**

- **第三方库：** 如 jQuery，bootstrap 之类的第三方库，
- **特殊的字体文件：** 如某些版权字体、font-awsome。
- **大尺寸图片或视频**
