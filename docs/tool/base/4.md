# 4、Webpack 构建，如何去优化生产环境运行性能？

要优化 Webpack 构建的应用程序性能，可以采取以下措施：

## 一、webpack 的配置优化

### 1、设置生产模式会自动启用一些优化策略

生产模式设置`mode`为`production`，这将自动启用一些`webpack`的优化选项，包括：**缓存**、**Tree Shaking**、**html 代码压缩**、**js 代码压缩**

### 2、设置合适代码拆分策略（webpack 的懒加载）

### 3、提高缓存命中率

代码打包的时候，在 **避免哈希碰撞** 的情况下，对生成的打包文件采用**更严格的哈希值计算**，可以有效降低打包的影响范围，从而利用浏览器的缓存，**提高缓存命中率**

### 4、对 html、js、css 进行代码压缩

`webpack5`会对`html`和`js`**默认压缩** ，`css` 需要**单独处理**，可以使用`MiniCssExtractPlugin `插件。

压缩会降低打包后生成文件的体积，从而提高加载速度。

### 5、图片、视频的压缩、转化

- **有损压缩、无损压缩：** 可以使用`webpack`插件和第三方软件，对图片和视频进行 **有损压缩** 或 **无损压缩**，降低体积
- **小图片转化为 dataUrl：** 小体积的图片，可以使用插件**(base64)**转化为 **dataUrl **，插入到`css`或`html`中。虽然体积会有所增大，但是一定程度上，减少 http 请求数量相对会提高加载速度。
- **多个小图片合并到一起：** 跟样式有关的小尺寸图片，比如用按钮的边框，可以考虑合并成一张图片，在 css 中用偏移量去控制。从而通过**减少文件数量来减少 http 请求**
- **字体图标库：** 跟图标有关的图片，可以考虑使用字体图标库，如**阿里的 iconFont**，**font-awsome**。
- **静态资源服务器、CDN：** 可以考虑使用静态资源服务器或 CDN 服务器，将大体积的图片和视频上传，在代码中使用 **URL 引用**

### 6、Js 和 CSS 的兼容性处理

- **Js：** 可以使用`postCss`去处理`CSS`的兼容性，
- **CSS：** 使用`babel`和`core-js`去处理 js 的兼容性

### 7、关闭或降低 sourceMap 的生成精度

非必要情况下，可以 **关闭**，甚至 **降低** sourceMap 生成 map 文件的**精细度** ，可以非常有效的降低代码生成体积，提高加载速度。

### 8、CDN 加速

以下资源可以使用 CDN 加速，来提高加载速度，但是要**控制数量**，**避免大幅度增加 Http 请求数量**

- **第三方库：** 如 jQuery，bootstrap 之类的第三方库，
- **特殊的字体文件：** 如某些版权字体、font-awsome。
- **大尺寸图片或视频**

### 9、使用 PWA 技术，处理某些极端情况

渐进式网络应用程序(progressive web application - PWA)：是一种可以提供类似于 native app(原生应用程序) 体验的 Web App 的技术。

其中最重要的是，在用户 **突然离线** 时，应用程序能够 **继续运行** 功能。通过 Service Workers 技术实现的。

## 二、代码中的优化

### 1、代码中的按需引入配合 Tree Shaking

我们在引入公共代码或第三方包的时候，只引入我们需要的部分，这样 webpack 会在打包带时候将未引入的部分剔除

### 2、路由或组件的按需加载，即懒加载

路由或组件的懒加载可以配合缓存和代码拆分

1. **优化 Webpack 配置**：检查并优化 Webpack 配置，包括使用合适的`entry`和`output`配置、配置正确的`mode`、使用最小化的`devtool`选项等。
2. **代码分割**：使用 Webpack 的代码分割功能将代码分割成更小的块，以便在需要时按需加载，而不是一次性加载整个应用程序。
3. **压缩代码**：使用 Webpack 的插件（如`UglifyJsPlugin`）来压缩和混淆 JavaScript 代码，以减小文件大小并提高加载速度。
4. **优化加载时间**：使用 Webpack 的`splitChunks`选项来拆分和合并公共模块，以避免重复加载，同时使用 Webpack 的`preload`和`prefetch`功能来预加载和推迟加载资源。
5. **懒加载**：使用`Webpack`的动态导入（`Dynamic Import`）或类似的懒加载方式，以延迟加载不必要的代码，只在需要时再加载。
6. **缓存**：使用`Webpack`的文件哈希（`File Hash`）来生成唯一的文件名，以便在文件内容发生变化时进行缓存失效。
7. **减少依赖**：精简项目的依赖，只引入必要的模块和库，避免加载不必要的资源和代码。
8. **并行构建**：使用`Webpack`的多线程（`Thread-loader`）、并行运行（`parallel-webpack`）等工具，以加快构建速度。
9. **优化图**片：使用`Webpack`的图片压缩插件（如`image-webpack-loader`）来优化图片文件大小，以减小资源加载和传输的时间。

通过以上措施，可以显著提高 Webpack 构建的应用程序性能，减少加载时间和资源消耗。
