# 13、什么是缓存穿透？如何在前端防止缓存穿透的问题？

## 一、解释

**缓存穿透（Cache Penetration）** 是缓存系统中的一种异常现象，通常指**大量请求查询不存在的数据**，导致请求直接穿透缓存层并频繁访问数据库，从而引发数据库压力过大甚至崩溃的问题。以下是详细解析：

---

## 二、核心原因
1. **恶意攻击**：攻击者故意构造大量不存在的数据请求（如无效的ID、随机字符串）。
2. **业务逻辑缺陷**：用户输入未校验，错误请求直接落到数据库。
3. **缓存未命中**：缓存中无数据时，未对“空结果”做合理处理。

---

## 三、缓存穿透 vs. 缓存击穿 vs. 缓存雪崩
| **现象** | **触发条件**                   | **影响范围**     |
| -------- | ------------------------------ | ---------------- |
| 缓存穿透 | 请求不存在的数据（如无效ID）   | 数据库直接承压   |
| 缓存击穿 | 热点数据过期后瞬间高并发请求   | 单个热点数据相关 |
| 缓存雪崩 | 大量缓存同时过期或缓存服务宕机 | 整个系统崩溃风险 |

---

## 四、解决方案
### 1. 缓存空对象（Null Caching）
   - **原理**：即使数据库查询结果为空，仍将空值（如`null`）写入缓存，并设置较短的过期时间（例如5分钟）。
   - **示例**：
     ```java
     // 伪代码：查询数据库后缓存空结果
     Object data = cache.get(key);
     if (data == null) {
         data = db.query(key);
         if (data == null) {
             cache.set(key, "NULL", 300); // 缓存空值5分钟
         } else {
             cache.set(key, data, 3600); // 缓存有效数据1小时
         }
     }
     return data;
     ```
   - **优点**：简单直接，能拦截大部分无效请求。
   - **缺点**：
     - 占用缓存空间（需设置合理的过期时间）。
     - 可能缓存短期无效数据（如用户输入错误）。

### 2. 布隆过滤器（Bloom Filter）
   - **原理**：在缓存层前加一个布隆过滤器，预存所有合法数据的标识符（如ID）。请求到达时，先通过布隆过滤器判断数据是否存在：
     - 若过滤器认为不存在，直接返回空结果。
     - 若过滤器认为存在，再查询缓存或数据库。
   - **实现步骤**：
     1. 初始化时将所有合法数据的键存入布隆过滤器。
     2. 查询时先检查布隆过滤器。
   - **示例**：
     ```python
     from pybloom_live import BloomFilter
     
     # 初始化布隆过滤器
     bf = BloomFilter(capacity=1000000, error_rate=0.001)
     for id in valid_ids:  # valid_ids是所有合法ID集合
         bf.add(id)
     
     # 查询逻辑
     def get_data(request_id):
         if request_id not in bf:
             return "Invalid ID"
         data = cache.get(request_id)
         if data is None:
             data = db.query(request_id)
             cache.set(request_id, data)
         return data
     ```
   - **优点**：内存占用极低，高效拦截无效请求。
   - **缺点**：
     - 有一定的误判率（可通过调整参数降低）。
     - 不支持删除已添加的数据（需结合其他数据结构）。

### 3. 请求校验与限流
   - **输入校验**：在业务层校验请求参数（如ID格式、范围）。
   - **限流熔断**：对异常高频请求的IP或用户实施限流（如Nginx限流、Redis计数器）。

### 4. 异步预热与监控
   - **热点预加载**：监控高频查询数据，提前缓存。
   - **实时监控**：对缓存未命中率（Cache Miss Rate）设置告警阈值。

---

## 五、实际场景案例
- **电商平台**：攻击者批量请求`product_id= -1`或`999999`等无效商品ID。
- **社交网络**：爬虫遍历不存在的用户ID（如`user_id=0`）。

---

## 六、总结
缓存穿透的本质是**无效请求绕过了缓存层的保护**，解决方案需结合业务场景选择：
1. 对明确无效的请求，用**布隆过滤器**拦截。
2. 对可能临时无效的请求，用**缓存空值**缓解。
3. 结合校验、限流、监控形成防御体系。
